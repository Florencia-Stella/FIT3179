{
   "$schema":"https://vega.github.io/schema/vega/v5.2.json",
   "height":600,
   "width":450,
   "data":[
      {
         "name":"table",
         "url":"https://raw.githubusercontent.com/Florencia-Stella/FIT3179/main/data/ghg_per_sector_2021.csv",
         "format":{
            "type":"csv"
         }
      },
      {
         "name":"data",
         "source":"table",
         "transform":[
            {
               "type":"fold",
               "fields":[
                  "CO2",
                  "CH4",
                  "N2O"
               ]
            }
         ]
      },
      {
         "name":"nodes",
         "source":"data",
         "transform":[
            {
               "type":"filter",
               "expr":"!groupSelector || groupSelector.Sector == datum.Sector || groupSelector.key == datum.key"
            },
            {
               "type":"formula",
               "expr":"datum.Sector+datum.key",
               "as":"key1"
            },
            {
               "type":"fold",
               "fields":[
                  "Sector",
                  "key"
               ],
               "as":[
                  "stack",
                  "gas_group"
               ]
            },
            {
               "type":"formula",
               "expr":"datum.stack == 'Sector' ? datum.Sector+' '+datum.key : datum.key+' '+datum.Sector",
               "as":"sortField"
            },
            {
               "type":"stack",
               "groupby":[
                  "stack"
               ],
               "sort":{
                  "field":"sortField",
                  "order":"descending"
               },
               "field":"value"
            },
            {
               "type":"formula",
               "expr":"(datum.y0+datum.y1)/2",
               "as":"yc"
            }
         ]
      },
      {
         "name":"groups",
         "source":"nodes",
         "transform":[
            {
               "type":"aggregate",
               "groupby":[
                  "stack",
                  "gas_group"
               ],
               "fields":[
                  "value"
               ],
               "ops":[
                  "sum"
               ],
               "as":[
                  "total"
               ]
            },
            {
               "type":"stack",
               "groupby":[
                  "stack"
               ],
               "sort":{
                  "field":"gas_group",
                  "order":"descending"
               },
               "field":"total"
            },
            {
               "type":"formula",
               "expr":"scale('y', datum.y0)",
               "as":"scaledY0"
            },
            {
               "type":"formula",
               "expr":"scale('y', datum.y1)",
               "as":"scaledY1"
            },
            {
               "type":"formula",
               "expr":"datum.stack == 'Sector'",
               "as":"rightLabel"
            },
            {
               "type":"formula",
               "expr":"datum.total/domain('y')[1]",
               "as":"percentage"
            }
         ]
      },
      {
         "name":"originNodes",
         "source":"nodes",
         "transform":[
            {
               "type":"filter",
               "expr":"datum.stack == 'Sector'"
            },
            {
               "type":"aggregate",
               "groupby":[
                  "Sector"
               ],
               "fields":[
                  "value",
                  "y0",
                  "y1"
               ],
               "ops":[
                  "sum",
                  "min",
                  "max"
               ]
            },
            {
               "type":"formula",
               "expr":"'Sector'",
               "as":"stack"
            }
         ]
      },
      {
         "name":"destinationNodes",
         "source":"nodes",
         "transform":[
            {
               "type":"filter",
               "expr":"datum.stack == 'key'"
            }
         ]
      },
      {
         "name":"edges",
         "source":"nodes",
         "transform":[
            {
               "type":"filter",
               "expr":"datum.stack == 'Sector'"
            },
            {
               "type":"lookup",
               "from":"destinationNodes",
               "key":"key1",
               "fields":[
                  "key1"
               ],
               "as":[
                  "target"
               ]
            },
            {
               "type":"linkpath",
               "orient":"horizontal",
               "shape":"diagonal",
               "sourceY":{
                  "expr":"scale('y', datum.yc)"
               },
               "sourceX":{
                  "expr":"scale('x', 'Sector') + bandwidth('x')"
               },
               "targetY":{
                  "expr":"scale('y', datum.target.yc)"
               },
               "targetX":{
                  "expr":"scale('x', 'key')"
               }
            },
            {
               "type":"formula",
               "expr":"range('y')[0]-scale('y', datum.value)",
               "as":"strokeWidth"
            },
            {
               "type":"formula",
               "expr":"datum.value/domain('y')[1]",
               "as":"percentage"
            }
         ]
      }
   ],
   "scales":[
      {
         "name":"x",
         "type":"band",
         "range":"width",
         "domain":[
            "Sector",
            "key"
         ],
         "paddingOuter":0.05,
         "paddingInner":0.95
      },
      {
         "name":"y",
         "type":"linear",
         "range":"height",
         "domain":{
            "data":"nodes",
            "field":"y1"
         }
      },
      {
         "name":"color",
         "type":"ordinal",
         "range":[
            "#587246",
            "#AEA04B",
            "#955F20",
            "#6D6552",
            "#EFA94A",
            "#646B63",
            "#FDF4E3",
            "#7FB5B5",
            "#1F3A3D",
            "#7F7679",
            "#9DA1AA"
         ],
         "domain":[
            "Agriculture",
            "Buildings",
            "Fuel Exploitation",
            "Industrial Combustion",
            "Power Industry",
            "Processes",
            "Transport",
            "Waste",
            "CO2",
            "CH4",
            "N2O"
         ]
      }
   ],
   "axes":[
      {
         "orient":"bottom",
         "scale":"x",
         "encode":{
            "labels":{
               "update":{
                  "text":{
                     "value":""
                  }
               }
            }
         }
      },
      {
         "orient":"left",
         "scale":"y",
         "title":"Sector"
      },
      {
         "orient":"right",
         "scale":"y",
         "title":"Greenhouse Gasses"
      }
   ],
   "marks":[
      {
         "type":"path",
         "name":"edgeMark",
         "from":{
            "data":"edges"
         },
         "clip":true,
         "encode":{
            "update":{
               "stroke":[
                  {
                     "test":"groupSelector && groupSelector.stack=='Sector'",
                     "scale":"color",
                     "field":"key"
                  },
                  {
                     "scale":"color",
                     "field":"Sector"
                  }
               ],
               "strokeWidth":{
                  "field":"strokeWidth"
               },
               "path":{
                  "field":"path"
               },
               "strokeOpacity":{
                  "signal":"!groupSelector && (groupHover.Sector == datum.Sector || groupHover.key == datum.key) ? 0.9 : 0.3"
               },
               "zindex":{
                  "signal":"!groupSelector && (groupHover.Sector == datum.Sector || groupHover.key == datum.key) ? 1 : 0"
               },
               "tooltip":{
                  "signal":"datum.Sector + ' â†’ ' + datum.key + '    = ' + format(datum.value, ',.2f') + ' MTCO2e (' + format(datum.percentage, '.1%') + ')'"
               }
            },
            "hover":{
               "strokeOpacity":{
                  "value":1
               }
            }
         }
      },
      {
         "type":"rect",
         "name":"groupMark",
         "from":{
            "data":"groups"
         },
         "encode":{
            "enter":{
               "fill":{
                  "scale":"color",
                  "field":"gas_group"
               },
               "width":{
                  "scale":"x",
                  "band":1
               }
            },
            "update":{
               "x":{
                  "scale":"x",
                  "field":"stack"
               },
               "y":{
                  "field":"scaledY0"
               },
               "y2":{
                  "field":"scaledY1"
               },
               "fillOpacity":{
                  "value":1
               },
               "tooltip":{
                  "signal":"datum.gas_group + '   ' + ' = ' + format(datum.total, ',.2f') + ' MTCO2e  (' + format(datum.percentage, '.0%') + ')'"
               }
            },
            "hover":{
               "fillOpacity":{
                  "value":1
               }
            }
         }
      },
      {
         "type":"text",
         "from":{
            "data":"groups"
         },
         "interactive":false,
         "encode":{
            "update":{
               "x":{
                  "signal":"scale('x', datum.stack) + (datum.rightLabel ? bandwidth('x') + 8 : -8)"
               },
               "yc":{
                  "signal":"(datum.scaledY0 + datum.scaledY1)/2"
               },
               "align":{
                  "signal":"datum.rightLabel ? 'left' : 'right'"
               },
               "baseline":{
                  "value":"middle"
               },
               "fontWeight":{
                  "value":"bold"
               },
               "text":{
                  "signal":"abs(datum.scaledY0-datum.scaledY1) > 13 ? datum.gas_group : ''"
               }
            }
         }
      },
      {
         "type":"group",
         "data":[
            {
               "name":"dataForShowAll",
               "values":[
                  {
                     
                  }
               ],
               "transform":[
                  {
                     "type":"filter",
                     "expr":"groupSelector"
                  }
               ]
            }
         ],
         "encode":{
            "enter":{
               "xc":{
                  "signal":"width/2"
               },
               "y":{
                  "value":30
               },
               "width":{
                  "value":80
               },
               "height":{
                  "value":30
               }
            }
         },
         "marks":[
            {
               "type":"group",
               "name":"groupReset",
               "from":{
                  "data":"dataForShowAll"
               },
               "encode":{
                  "enter":{
                     "cornerRadius":{
                        "value":6
                     },
                     "fill":{
                        "value":"#f5f5f5"
                     },
                     "stroke":{
                        "value":"#c1c1c1"
                     },
                     "strokeWidth":{
                        "value":2
                     },
                     "height":{
                        "field":{
                           "group":"height"
                        }
                     },
                     "width":{
                        "field":{
                           "group":"width"
                        }
                     }
                  },
                  "update":{
                     "opacity":{
                        "value":1
                     }
                  },
                  "hover":{
                     "opacity":{
                        "value":0.7
                     }
                  }
               },
               "marks":[
                  {
                     "type":"text",
                     "interactive":false,
                     "encode":{
                        "enter":{
                           "xc":{
                              "field":{
                                 "group":"width"
                              },
                              "mult":0.5
                           },
                           "yc":{
                              "field":{
                                 "group":"height"
                              },
                              "mult":0.5,
                              "offset":2
                           },
                           "align":{
                              "value":"center"
                           },
                           "baseline":{
                              "value":"middle"
                           },
                           "fontWeight":{
                              "value":"bold"
                           },
                           "text":{
                              "value":"Show All"
                           }
                        }
                     }
                  }
               ]
            }
         ]
      },
      {
         "type":"rect",
         "from":{
            "data":"nodes"
         },
         "encode":{
            "enter":{
               "stroke":{
                  "value":"#000"
               },
               "strokeWidth":{
                  "value":0.1
               },
               "width":{
                  "scale":"x",
                  "band":1
               },
               "x":{
                  "scale":"x",
                  "field":"stack"
               },
               "y":{
                  "field":"y0",
                  "scale":"y"
               },
               "y2":{
                  "field":"y1",
                  "scale":"y"
               }
            }
         }
      }
   ],
   "signals":[
      {
         "name":"groupHover",
         "value":{
            
         },
         "on":[
            {
               "events":"@groupMark:mouseover",
               "update":"{Sector:datum.stack=='Sector' && datum.gas_group, key:datum.stack=='key' && datum.gas_group}"
            },
            {
               "events":"mouseout",
               "update":"{}"
            }
         ]
      },
      {
         "name":"groupSelector",
         "value":false
      }
   ]
}